# 0.7.3 - OG Image Generation

## Goal

Create dynamic Open Graph images for blog posts using @vercel/og with post title, persona, and optional hero image background.

## Deliverables

- [ ] Directus fields: og_image (file), og_generate (boolean)
- [ ] API route for OG image generation
- [ ] Post title + persona on hero image background
- [ ] Fallback gradient when no hero image
- [ ] Support for custom OG image override

## Directus Schema Changes

Add to posts collection in `blog-schema.yaml`:

```yaml
- field: og_image
  type: uuid
  schema:
    is_nullable: true
    foreign_key_table: directus_files
  meta:
    interface: file-image
    display: image
    note: "Custom OG image (overrides auto-generation)"
    sort: 13

- field: og_generate
  type: boolean
  schema:
    default_value: true
    is_nullable: false
  meta:
    interface: boolean
    display: boolean
    note: "Generate OG image automatically (uses hero image as background)"
    sort: 14
```

## Type Updates

```typescript
// packages/blog/src/types/post.ts
export interface Post {
  // ... existing fields
  ogImage?: PostImage;      // Custom OG image override
  ogGenerate?: boolean;     // Auto-generate OG image (default: true)
}
```

## OG Image Route

```typescript
// apps/web/app/api/og/blog/[slug]/route.tsx
import { ImageResponse } from 'next/og';
import { createBlogRepository } from '@/lib/blog/repository';

export const runtime = 'edge';

export async function GET(
  request: Request,
  { params }: { params: Promise<{ slug: string }> }
) {
  const { slug } = await params;
  const repository = createBlogRepository();

  try {
    const post = await repository.getPost(slug);
    if (!post) {
      return new Response('Not found', { status: 404 });
    }

    // If custom OG image exists, redirect to it
    if (post.ogImage) {
      return Response.redirect(post.ogImage.src);
    }

    // Generate dynamic image
    return new ImageResponse(
      (
        <div
          style={{
            width: '100%',
            height: '100%',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'flex-end',
            padding: '60px',
            background: post.image
              ? `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url(${post.image.src})`
              : 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
            backgroundSize: 'cover',
            backgroundPosition: 'center',
          }}
        >
          {/* Persona badge */}
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              marginBottom: '20px',
            }}
          >
            <div
              style={{
                width: '16px',
                height: '16px',
                borderRadius: '50%',
                backgroundColor: post.persona.color,
              }}
            />
            <span style={{ color: '#a1a1aa', fontSize: '24px' }}>
              {post.persona.name}
            </span>
          </div>

          {/* Title */}
          <h1
            style={{
              color: 'white',
              fontSize: '64px',
              fontWeight: 700,
              lineHeight: 1.2,
              margin: 0,
            }}
          >
            {post.title}
          </h1>

          {/* Site badge */}
          <div
            style={{
              position: 'absolute',
              top: '40px',
              right: '40px',
              color: '#8b5cf6',
              fontSize: '28px',
              fontWeight: 600,
            }}
          >
            sbozh.me
          </div>
        </div>
      ),
      {
        width: 1200,
        height: 630,
      }
    );
  } catch {
    return new Response('Error generating image', { status: 500 });
  }
}
```

## Update Metadata to Use OG Route

```typescript
// In generateMetadata
const ogImage = post.ogImage?.src
  || (post.ogGenerate !== false
    ? `/api/og/blog/${post.slug}`
    : post.image?.src || '/og/blog-default.png');
```

## Files to Modify

| File | Action |
|------|--------|
| `apps/web/directus/snapshots/blog-schema.yaml` | Add og_image, og_generate fields |
| `packages/blog/src/types/post.ts` | Add ogImage?, ogGenerate? |
| `packages/blog/src/data/directus-repository.ts` | Map new fields |
| `apps/web/app/api/og/blog/[slug]/route.tsx` | NEW: OG generation |
| `apps/web/app/(main)/blog/[slug]/page.tsx` | Update generateMetadata |

## Acceptance Criteria

- [ ] `/api/og/blog/[slug]` returns valid PNG image
- [ ] Post title displayed prominently
- [ ] Persona name and color indicator shown
- [ ] Hero image used as background when available
- [ ] Gradient fallback when no hero image
- [ ] Custom OG image override works
- [ ] og_generate=false disables auto-generation
- [ ] Image dimensions: 1200x630
- [ ] sbozh.me branding visible
