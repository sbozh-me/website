# 0.6.4 - Polish & Tests

## Goal

Integration tests, error handling, and edge case coverage for the Directus integration.

## Deliverables

- [ ] Unit tests for DirectusRepository (90%+ coverage)
- [ ] Integration test suite (can run against Docker Directus)
- [ ] Graceful error handling for all failure modes
- [ ] Logging for debugging (optional, configurable)
- [ ] README documentation for setup and usage

## Test Files

```
packages/blog/
  src/
    data/
      __tests__/
        directus-repository.test.ts    # Unit tests with mocked SDK
        directus-repository.integration.test.ts  # Integration tests
```

## Unit Tests (Mocked)

```typescript
// packages/blog/src/data/__tests__/directus-repository.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { DirectusRepository } from '../directus-repository';

// Mock the Directus SDK
vi.mock('@directus/sdk', () => ({
  createDirectus: vi.fn(() => ({
    with: vi.fn().mockReturnThis(),
    request: vi.fn(),
  })),
  rest: vi.fn(),
  staticToken: vi.fn(),
  readItems: vi.fn(),
}));

describe('DirectusRepository', () => {
  describe('getPosts', () => {
    it('excludes drafts by default', async () => { /* ... */ });
    it('includes drafts when includeDrafts is true', async () => { /* ... */ });
    it('filters by persona slug', async () => { /* ... */ });
    it('filters by tag slug (M2M)', async () => { /* ... */ });
    it('filters by year range', async () => { /* ... */ });
    it('combines multiple filters', async () => { /* ... */ });
    it('returns empty array when no posts match', async () => { /* ... */ });
    it('maps Directus response to PostListItem', async () => { /* ... */ });
  });

  describe('getPost', () => {
    it('returns post by slug', async () => { /* ... */ });
    it('returns null when post not found', async () => { /* ... */ });
    it('returns null for draft when includeDrafts is false', async () => { /* ... */ });
    it('returns draft when includeDrafts is true', async () => { /* ... */ });
    it('maps full content field', async () => { /* ... */ });
  });

  describe('getPersonas', () => {
    it('returns all personas', async () => { /* ... */ });
    it('maps Directus response to Persona type', async () => { /* ... */ });
  });

  describe('getTags', () => {
    it('returns all tags', async () => { /* ... */ });
    it('maps Directus response to Tag type', async () => { /* ... */ });
  });

  describe('image mapping', () => {
    it('generates correct asset URL', async () => { /* ... */ });
    it('handles posts without images', async () => { /* ... */ });
  });
});
```

## Integration Tests

```typescript
// packages/blog/src/data/__tests__/directus-repository.integration.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { DirectusRepository } from '../directus-repository';

// Skip if DIRECTUS_URL not set (CI without Directus)
const runIntegration = !!process.env.DIRECTUS_URL;

describe.skipIf(!runIntegration)('DirectusRepository Integration', () => {
  let repo: DirectusRepository;

  beforeAll(() => {
    repo = new DirectusRepository({
      url: process.env.DIRECTUS_URL!,
      token: process.env.DIRECTUS_TOKEN,
    });
  });

  it('connects to Directus', async () => {
    const personas = await repo.getPersonas();
    expect(Array.isArray(personas)).toBe(true);
  });

  it('fetches posts with relations', async () => {
    const posts = await repo.getPosts();
    if (posts.length > 0) {
      expect(posts[0].persona).toBeDefined();
      expect(posts[0].persona.name).toBeDefined();
    }
  });

  // ... more integration tests
});
```

## Error Handling

```typescript
// packages/blog/src/data/directus-repository.ts

// Add error handling wrapper
async getPost(slug: string): Promise<Post | null> {
  try {
    const posts = await this.client.request(
      readItems('posts', {
        filter: { slug: { _eq: slug } },
        limit: 1,
      })
    );
    return posts[0] ? this.mapToPost(posts[0]) : null;
  } catch (error) {
    if (this.isDirectusError(error)) {
      // 403: Permission denied (maybe draft access)
      if (error.status === 403) {
        return null;
      }
      // 404: Collection not found
      if (error.status === 404) {
        throw new Error('Blog posts collection not found in Directus');
      }
    }
    // Connection errors
    if (error instanceof TypeError && error.message.includes('fetch')) {
      throw new Error(`Cannot connect to Directus at ${this.baseUrl}`);
    }
    throw error;
  }
}

private isDirectusError(error: unknown): error is { status: number; message: string } {
  return (
    typeof error === 'object' &&
    error !== null &&
    'status' in error &&
    typeof (error as any).status === 'number'
  );
}
```

## Edge Cases to Handle

| Case | Behavior |
|------|----------|
| Directus unavailable | Throw descriptive error |
| Invalid/expired token | 403 error, return null for getPost |
| Post not found | Return null (not throw) |
| Empty filter results | Return empty array |
| Malformed filter params | Ignore invalid params |
| Image asset not found | Return post without image |
| M2M relation empty | Return empty tags array |
| Network timeout | Throw with timeout message |

## Optional: Logging

```typescript
// packages/blog/src/data/directus-repository.ts
export interface DirectusConfig {
  url: string;
  token?: string;
  includeDrafts?: boolean;
  debug?: boolean;  // Enable debug logging
}

// In methods:
if (this.debug) {
  console.log('[DirectusRepository] getPosts filter:', directusFilter);
}
```

## Documentation Updates

Update `packages/blog/README.md`:

```markdown
## Directus Integration

### Setup

1. Start Directus:
   ```bash
   cd apps/web/directus
   docker compose up -d
   ```

2. Set environment variables:
   ```bash
   export DIRECTUS_URL=http://localhost:8055
   export DIRECTUS_TOKEN=your-token
   ```

3. Use DirectusRepository:
   ```typescript
   import { DirectusRepository } from '@sbozh/blog/data';

   const repo = new DirectusRepository({
     url: process.env.DIRECTUS_URL,
     token: process.env.DIRECTUS_TOKEN,
   });

   const posts = await repo.getPosts();
   ```

### Draft Preview

To preview draft posts, authenticate with Directus and use `?draft=true`:

```
/blog?draft=true
/blog/my-draft-post?draft=true
```

### Running Tests

```bash
# Unit tests (no Directus needed)
pnpm test

# Integration tests (requires Directus)
DIRECTUS_URL=http://localhost:8055 DIRECTUS_TOKEN=xxx pnpm test
```
```

## Acceptance Criteria

- [ ] Unit test coverage >= 90% for DirectusRepository
- [ ] Integration tests pass against running Directus
- [ ] Integration tests skip gracefully when no Directus
- [ ] Connection errors have clear error messages
- [ ] 403 errors handled gracefully (return null)
- [ ] Empty results don't throw
- [ ] README documents Directus setup
- [ ] README documents draft preview
- [ ] README documents running tests
- [ ] Optional debug logging works
