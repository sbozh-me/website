# 0.5.4 - Blog List Page Implementation

## Goal

Implement the full blog list page in apps/web using blog package components with mock data from the repository.

## Deliverables

- [ ] Updated `/blog` page replacing placeholder
- [ ] Server-side data fetching via BlogRepository
- [ ] Client-side filtering with URL state
- [ ] Responsive layout
- [ ] Loading and error states
- [ ] Page tests

## Files to Create/Modify

```
apps/web/
  app/(main)/blog/
    page.tsx              # Replace placeholder
    page.test.tsx         # Update tests
    BlogListClient.tsx    # Client component for filtering
    loading.tsx           # Loading state
    error.tsx             # Error boundary
  lib/
    blog/
      repository.ts       # Repository instance (uses mock for now)
```

## Repository Setup

```typescript
// apps/web/lib/blog/repository.ts
import { MockBlogRepository } from '@sbozh/blog/data';
import type { BlogRepository } from '@sbozh/blog/data';

// Use MockRepository for development
// Will be replaced with DirectusRepository in 0.6.0
export const blogRepository: BlogRepository = new MockBlogRepository();
```

## Page Implementation

### Server Component (page.tsx)

```typescript
// app/(main)/blog/page.tsx
import { Suspense } from 'react';
import { blogRepository } from '@/lib/blog/repository';
import { BlogListClient } from './BlogListClient';
import BlogLoading from './loading';

export const metadata = {
  title: 'Blog | Obsidian Forge',
  description: 'Thoughts on code, creativity, and building things that matter.',
};

export default async function BlogPage() {
  const [posts, personas, tags] = await Promise.all([
    blogRepository.getPosts(),
    blogRepository.getPersonas(),
    blogRepository.getTags(),
  ]);

  return (
    <div className="mx-auto px-6 md:px-12 lg:px-24 py-12">
      <header className="mb-12">
        <h1 className="text-3xl font-bold tracking-tight">Blog</h1>
        <p className="mt-2 text-muted-foreground">
          Thoughts on code, creativity, and building things that matter.
        </p>
      </header>

      <Suspense fallback={<BlogLoading />}>
        <BlogListClient
          initialPosts={posts}
          personas={personas}
          tags={tags}
        />
      </Suspense>
    </div>
  );
}
```

### Client Component (filtering)

```typescript
// app/(main)/blog/BlogListClient.tsx
'use client';

import { useMemo } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import {
  FilterBar,
  Timeline,
  EmptyState,
  usePostFilters
} from '@sbozh/blog';
import type { PostListItem, Persona, Tag, PostFilters } from '@sbozh/blog/types';

interface BlogListClientProps {
  initialPosts: PostListItem[];
  personas: Persona[];
  tags: Tag[];
}

export function BlogListClient({
  initialPosts,
  personas,
  tags
}: BlogListClientProps) {
  const searchParams = useSearchParams();
  const router = useRouter();

  // Initialize filters from URL
  const initialFilters: PostFilters = {
    persona: searchParams.get('persona') || undefined,
    tag: searchParams.get('tag') || undefined,
    year: searchParams.get('year') ? Number(searchParams.get('year')) : undefined,
  };

  const { filters, setFilter, clearFilters } = usePostFilters(initialFilters);

  // Sync filters to URL
  const updateURL = (newFilters: PostFilters) => {
    const params = new URLSearchParams();
    if (newFilters.persona) params.set('persona', newFilters.persona);
    if (newFilters.tag) params.set('tag', newFilters.tag);
    if (newFilters.year) params.set('year', String(newFilters.year));

    const query = params.toString();
    router.push(query ? `?${query}` : '/blog', { scroll: false });
  };

  // Filter posts client-side
  const filteredPosts = useMemo(() => {
    return initialPosts.filter(post => {
      if (filters.persona && post.persona.slug !== filters.persona) return false;
      if (filters.tag && !post.tags.some(t => t.slug === filters.tag)) return false;
      if (filters.year && new Date(post.date).getFullYear() !== filters.year) return false;
      return true;
    });
  }, [initialPosts, filters]);

  const handleFilterChange = (key: keyof PostFilters, value: string | number | undefined) => {
    const newFilters = { ...filters, [key]: value };
    setFilter(key, value);
    updateURL(newFilters);
  };

  return (
    <>
      <FilterBar
        personas={personas}
        tags={tags}
        filters={filters}
        onFiltersChange={handleFilterChange}
      />

      {filteredPosts.length === 0 ? (
        <EmptyState message="No posts found matching your filters." />
      ) : (
        <Timeline posts={filteredPosts} />
      )}
    </>
  );
}
```

### Loading State

```typescript
// app/(main)/blog/loading.tsx
export default function BlogLoading() {
  return (
    <div className="animate-pulse">
      {/* Filter skeleton */}
      <div className="flex gap-4 mb-8">
        <div className="h-10 w-28 bg-muted rounded" />
        <div className="h-10 w-28 bg-muted rounded" />
        <div className="h-10 w-28 bg-muted rounded" />
      </div>

      {/* Post card skeletons */}
      {[1, 2, 3].map(i => (
        <div key={i} className="bg-muted rounded-lg p-6 mb-4">
          <div className="h-4 w-48 bg-muted-foreground/20 rounded mb-3" />
          <div className="h-6 w-3/4 bg-muted-foreground/20 rounded mb-2" />
          <div className="h-4 w-full bg-muted-foreground/20 rounded" />
        </div>
      ))}
    </div>
  );
}
```

### Error Boundary

```typescript
// app/(main)/blog/error.tsx
'use client';

export default function BlogError({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  return (
    <div className="text-center py-16">
      <h2 className="text-xl font-semibold mb-4">Something went wrong</h2>
      <p className="text-muted-foreground mb-6">
        Failed to load blog posts. Please try again.
      </p>
      <button
        onClick={reset}
        className="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90"
      >
        Try again
      </button>
    </div>
  );
}
```

## Responsive Behavior

- Mobile (<768px): Full width cards, stacked filters
- Tablet (768-1024px): Full width cards, inline filters
- Desktop (>1024px): Max width container, all filters visible

```tsx
// FilterBar responsive
<div className="filters flex flex-col sm:flex-row gap-4 mb-8">
  <div className="flex flex-wrap gap-2 sm:gap-4">
    <DateFilter ... />
    <TagFilter ... />
    <PersonaFilter ... />
  </div>
  <div className="sm:ml-auto">
    <SearchPlaceholder />
  </div>
</div>
```

## Demo

- `/blog` shows timeline of all posts (from mock data)
- Filter by persona: `/blog?persona=founder`
- Filter by tag: `/blog?tag=tech`
- Filter by year: `/blog?year=2025`
- Combined: `/blog?persona=founder&year=2025`
- Filters persist on page refresh

## Acceptance Criteria

- [ ] Blog page renders timeline of posts from MockRepository
- [ ] Filter dropdowns populated with personas/tags
- [ ] Clicking filter updates URL and filters posts
- [ ] URL params restore filter state on refresh
- [ ] Empty state shows when no posts match filters
- [ ] Loading skeleton displays during data fetch
- [ ] Error boundary catches and displays errors
- [ ] Responsive layout works on all screen sizes
- [ ] Repository is abstracted (easy to swap in 0.6.0)
- [ ] All tests pass
