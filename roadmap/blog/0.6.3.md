# 0.6.3 - Frontend Integration

## Goal

Replace MockBlogRepository with DirectusRepository in the web app.

## Deliverables

- [ ] Repository factory with environment-based switching
- [ ] Blog list page fetches from Directus
- [ ] Blog post page fetches from Directus
- [ ] Static generation works with generateStaticParams
- [ ] Images served from Directus assets
- [ ] Fallback to MockRepository when DIRECTUS_URL not set

## Files to Create/Modify

```
apps/web/
  lib/
    blog/
      repository.ts           # New: Repository factory
  app/(main)/blog/
    page.tsx                   # Update to use factory
    [slug]/page.tsx            # Update to use factory
  .env.local                   # Add Directus env vars
  .env.example                 # Document env vars
```

## Repository Factory

```typescript
// apps/web/lib/blog/repository.ts
import { DirectusRepository, MockBlogRepository } from '@sbozh/blog/data';
import type { BlogRepository } from '@sbozh/blog/data';

export function createBlogRepository(options?: {
  includeDrafts?: boolean;
}): BlogRepository {
  const directusUrl = process.env.DIRECTUS_URL;

  if (directusUrl) {
    return new DirectusRepository({
      url: directusUrl,
      token: process.env.DIRECTUS_TOKEN,
      includeDrafts: options?.includeDrafts,
    });
  }

  // Fallback to mock for testing/CI
  console.warn('DIRECTUS_URL not set, using MockBlogRepository');
  return new MockBlogRepository();
}

// Default instance for simple imports
export const blogRepository = createBlogRepository();
```

## Environment Variables

```bash
# apps/web/.env.local
DIRECTUS_URL=http://localhost:8055
DIRECTUS_TOKEN=your-static-token-here
```

```bash
# apps/web/.env.example
# Directus CMS connection
# Leave empty to use mock data
DIRECTUS_URL=
DIRECTUS_TOKEN=
```

## Blog List Page Update

```typescript
// apps/web/app/(main)/blog/page.tsx
import { createBlogRepository } from '@/lib/blog/repository';

export default async function BlogPage() {
  const repository = createBlogRepository();
  const [posts, personas, tags] = await Promise.all([
    repository.getPosts(),
    repository.getPersonas(),
    repository.getTags(),
  ]);

  // ... rest unchanged
}
```

## Blog Post Page Update

```typescript
// apps/web/app/(main)/blog/[slug]/page.tsx
import { createBlogRepository } from '@/lib/blog/repository';

export default async function BlogPostPage({ params }: PageProps) {
  const { slug } = await params;
  const repository = createBlogRepository();
  const post = await repository.getPost(slug);

  if (!post) {
    notFound();
  }

  // ... rest unchanged
}

export async function generateStaticParams() {
  const repository = createBlogRepository();
  const posts = await repository.getPosts();
  return posts.map((post) => ({ slug: post.slug }));
}
```

## Next.js Image Configuration

Update `next.config.ts` to allow Directus images:

```typescript
// apps/web/next.config.ts
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'http',
        hostname: 'localhost',
        port: '8055',
        pathname: '/assets/**',
      },
      // Add production Directus URL when deployed
    ],
  },
};
```

## Acceptance Criteria

- [ ] Repository factory exports `createBlogRepository` and `blogRepository`
- [ ] When DIRECTUS_URL is set, uses DirectusRepository
- [ ] When DIRECTUS_URL is not set, falls back to MockBlogRepository
- [ ] Blog list page loads posts from Directus
- [ ] Blog post page loads individual post from Directus
- [ ] `generateStaticParams` generates paths from Directus
- [ ] Images load correctly from Directus assets
- [ ] Environment variables documented in .env.example
- [ ] Build succeeds with mock data (CI compatibility)
- [ ] Dev server works with Directus running
