# 0.5.5 - Post Page Implementation

## Goal

Implement the full blog post page in apps/web with MDX rendering, table of contents, and proper typography using mock data.

## Deliverables

- [ ] Dynamic post route `/blog/[slug]`
- [ ] MDX content rendering
- [ ] Sticky table of contents
- [ ] Syntax highlighting for code blocks
- [ ] Static generation for all posts
- [ ] SEO metadata
- [ ] Page tests

## Files to Create/Modify

```
apps/web/
  app/(main)/blog/
    [slug]/
      page.tsx            # Post page
      page.test.tsx       # Tests
      loading.tsx         # Loading state
      not-found.tsx       # 404 state
  lib/
    blog/
      mdx.ts              # MDX compilation
```

## Dependencies

Add to apps/web:

```json
{
  "dependencies": {
    "@mdx-js/mdx": "^3.0.1",
    "@mdx-js/react": "^3.0.1",
    "rehype-slug": "^6.0.0",
    "rehype-prism-plus": "^2.0.0"
  }
}
```

## Page Implementation

### Dynamic Route (page.tsx)

```typescript
// app/(main)/blog/[slug]/page.tsx
import { notFound } from 'next/navigation';
import { blogRepository } from '@/lib/blog/repository';
import {
  PostLayout,
  PostHeader,
  Prose
} from '@sbozh/blog/components';
import { extractHeadings } from '@sbozh/blog/utils';
import { compileMDX } from '@/lib/blog/mdx';

interface PostPageProps {
  params: Promise<{ slug: string }>;
}

// Generate static paths for all posts
export async function generateStaticParams() {
  const posts = await blogRepository.getPosts();
  return posts.map((post) => ({
    slug: post.slug,
  }));
}

// Generate metadata for SEO
export async function generateMetadata({ params }: PostPageProps) {
  const { slug } = await params;
  const post = await blogRepository.getPost(slug);

  if (!post) {
    return { title: 'Post Not Found' };
  }

  return {
    title: `${post.title} | Obsidian Forge`,
    description: post.excerpt,
    openGraph: {
      title: post.title,
      description: post.excerpt,
      type: 'article',
      publishedTime: post.date,
      authors: [post.persona.name],
      tags: post.tags.map(t => t.name),
    },
  };
}

export default async function PostPage({ params }: PostPageProps) {
  const { slug } = await params;
  const post = await blogRepository.getPost(slug);

  if (!post) {
    notFound();
  }

  // Compile MDX content
  const { content, headings } = await compileMDX(post.content);

  // Extract TOC from headings
  const toc = extractHeadings(headings);

  return (
    <div className="mx-auto px-6 md:px-12 lg:px-24 py-12">
      <PostLayout toc={toc}>
        <PostHeader post={post} />
        <Prose>{content}</Prose>
      </PostLayout>
    </div>
  );
}
```

### MDX Compilation

```typescript
// lib/blog/mdx.ts
import { compile, run } from '@mdx-js/mdx';
import * as runtime from 'react/jsx-runtime';
import rehypeSlug from 'rehype-slug';
import rehypePrismPlus from 'rehype-prism-plus';
import { visit } from 'unist-util-visit';
import { toString } from 'hast-util-to-string';

interface Heading {
  id: string;
  text: string;
  level: number;
}

interface CompileMDXResult {
  content: React.ReactNode;
  headings: Heading[];
}

export async function compileMDX(source: string): Promise<CompileMDXResult> {
  const headings: Heading[] = [];

  // Custom rehype plugin to extract headings
  const rehypeExtractHeadings = () => {
    return (tree: any) => {
      visit(tree, 'element', (node) => {
        if (['h2', 'h3'].includes(node.tagName)) {
          const id = node.properties?.id;
          const text = toString(node);
          const level = parseInt(node.tagName[1]);
          if (id && text) {
            headings.push({ id, text, level });
          }
        }
      });
    };
  };

  const code = await compile(source, {
    outputFormat: 'function-body',
    rehypePlugins: [
      rehypeSlug,
      [rehypePrismPlus, { ignoreMissing: true }],
      rehypeExtractHeadings,
    ],
  });

  const { default: MDXContent } = await run(code, runtime);

  return {
    content: <MDXContent />,
    headings,
  };
}
```

### Not Found State

```typescript
// app/(main)/blog/[slug]/not-found.tsx
import Link from 'next/link';

export default function PostNotFound() {
  return (
    <div className="mx-auto px-6 md:px-12 lg:px-24 py-24">
      <div className="text-center">
        <h1 className="text-3xl font-bold mb-4">Post not found</h1>
        <p className="text-muted-foreground mb-6">
          The post you're looking for doesn't exist or has been removed.
        </p>
        <Link
          href="/blog"
          className="text-primary hover:underline"
        >
          ← Back to blog
        </Link>
      </div>
    </div>
  );
}
```

### Loading State

```typescript
// app/(main)/blog/[slug]/loading.tsx
export default function PostLoading() {
  return (
    <div className="mx-auto px-6 md:px-12 lg:px-24 py-12">
      <div className="max-w-2xl mx-auto animate-pulse">
        {/* Persona */}
        <div className="flex items-center gap-2 mb-4">
          <div className="w-2 h-2 bg-muted rounded-full" />
          <div className="h-4 w-24 bg-muted rounded" />
        </div>

        {/* Title */}
        <div className="h-10 w-3/4 bg-muted rounded mb-4" />

        {/* Meta */}
        <div className="h-4 w-48 bg-muted rounded mb-12" />

        {/* Content skeleton */}
        <div className="space-y-4">
          <div className="h-4 w-full bg-muted rounded" />
          <div className="h-4 w-5/6 bg-muted rounded" />
          <div className="h-4 w-full bg-muted rounded" />
          <div className="h-4 w-4/5 bg-muted rounded" />
        </div>
      </div>
    </div>
  );
}
```

## Syntax Highlighting

Prism theme matching Obsidian Forge (add to styles):

```css
/* styles/prism-forge.css */
code[class*="language-"],
pre[class*="language-"] {
  color: #e5e7eb;
  background: none;
  font-family: var(--font-mono);
  font-size: 0.9rem;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.6;
  tab-size: 2;
}

pre[class*="language-"] {
  background: #0f0f14;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  overflow: auto;
  margin: 32px 0;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #6b7280;
}

.token.punctuation {
  color: #9ca3af;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol {
  color: #06b6d4;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin {
  color: #22c55e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #f59e0b;
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #8b5cf6;
}

.token.function,
.token.class-name {
  color: #f59e0b;
}

.token.regex,
.token.important,
.token.variable {
  color: #e5e7eb;
}

/* Line highlighting */
.highlight-line {
  background-color: rgba(139, 92, 246, 0.1);
  border-left: 4px solid #8b5cf6;
  margin-left: -20px;
  padding-left: 16px;
}
```

## Navigation

Add "Back to blog" link in PostLayout:

```tsx
<div className="mb-8">
  <Link
    href="/blog"
    className="text-sm text-muted-foreground hover:text-foreground transition-colors"
  >
    ← Back to blog
  </Link>
</div>
```

## Demo

- `/blog/why-i-started-sbozh` shows full post (from mock data)
- TOC sticky on right side (desktop)
- Code blocks syntax highlighted
- Images full width
- SEO meta tags generated

## Acceptance Criteria

- [ ] Post page renders MDX content correctly
- [ ] Persona with colored indicator displays
- [ ] Title, date, reading time, tags shown
- [ ] Table of contents generated from h2/h3 headings
- [ ] TOC is sticky and highlights active section
- [ ] Code blocks use Forge syntax theme
- [ ] Images render full width with captions
- [ ] Static paths generated for all posts (from MockRepository)
- [ ] SEO metadata correct (title, description, OG tags)
- [ ] 404 page shown for invalid slugs
- [ ] Loading state displays skeleton
- [ ] "Back to blog" navigation works
- [ ] Repository is abstracted (easy to swap in 0.6.0)
- [ ] All tests pass
