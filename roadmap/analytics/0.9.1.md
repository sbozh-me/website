# 0.9.1 - Umami Analytics Integration

## Goal
Integrate Umami analytics tracking into the Next.js application with automatic page view tracking, custom events, and proper Content Security Policy configuration.

## Deliverables
- [ ] Install Umami tracking script in Next.js
- [ ] Create analytics provider component
- [ ] Configure CSP headers for analytics
- [ ] Implement automatic page view tracking that can be turn of by users cookie choise
- [ ] Set up environment-based tracking control
- [ ] Verify dashboard data collection
- [ ] Document tracking implementation

## Implementation

### Analytics Provider Component

```tsx
// packages/web/src/providers/AnalyticsProvider.tsx
'use client';

import Script from 'next/script';
import { usePathname, useSearchParams } from 'next/navigation';
import { useEffect, Suspense } from 'react';

interface AnalyticsProviderProps {
  children: React.ReactNode;
}

function AnalyticsContent({ children }: AnalyticsProviderProps) {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // Track page views on route change
  useEffect(() => {
    if (typeof window !== 'undefined' && window.umami) {
      window.umami.track('pageview', {
        url: pathname,
        referrer: document.referrer,
      });
    }
  }, [pathname, searchParams]);

  return <>{children}</>;
}

export function AnalyticsProvider({ children }: AnalyticsProviderProps) {
  const websiteId = process.env.NEXT_PUBLIC_UMAMI_WEBSITE_ID;
  const scriptSrc = process.env.NEXT_PUBLIC_UMAMI_SCRIPT_URL;
  const isDevelopment = process.env.NODE_ENV === 'development';
  const analyticsEnabled = process.env.NEXT_PUBLIC_ANALYTICS_ENABLED === 'true';

  // Skip analytics in development unless explicitly enabled
  if (!analyticsEnabled || (isDevelopment && !process.env.NEXT_PUBLIC_FORCE_ANALYTICS)) {
    return <>{children}</>;
  }

  if (!websiteId || !scriptSrc) {
    console.warn('Analytics: Missing configuration');
    return <>{children}</>;
  }

  return (
    <>
      <Script
        src={scriptSrc}
        data-website-id={websiteId}
        data-domains={process.env.NEXT_PUBLIC_ANALYTICS_DOMAINS}
        data-auto-track="false" // We'll handle tracking manually for better control
        strategy="afterInteractive"
        onLoad={() => {
          console.log('Analytics: Umami loaded');
        }}
      />
      <Suspense fallback={children}>
        <AnalyticsContent>{children}</AnalyticsContent>
      </Suspense>
    </>
  );
}
```

### Custom Hooks for Event Tracking

```tsx
// packages/web/src/hooks/useAnalytics.ts
import { useCallback } from 'react';

declare global {
  interface Window {
    umami?: {
      track: (event: string, data?: Record<string, any>) => void;
    };
  }
}

interface TrackEventOptions {
  category?: string;
  label?: string;
  value?: number;
  [key: string]: any;
}

export function useAnalytics() {
  const track = useCallback((event: string, options?: TrackEventOptions) => {
    if (typeof window !== 'undefined' && window.umami) {
      window.umami.track(event, options);
    } else if (process.env.NODE_ENV === 'development') {
      console.log('[Analytics Dev]', event, options);
    }
  }, []);

  const trackClick = useCallback((label: string, category = 'click') => {
    track('click', { category, label });
  }, [track]);

  const trackFormSubmit = useCallback((formName: string) => {
    track('form_submit', { form: formName });
  }, [track]);

  const trackError = useCallback((error: string, context?: Record<string, any>) => {
    track('error', { error, ...context });
  }, [track]);

  const trackSearch = useCallback((query: string, results?: number) => {
    track('search', { query, results });
  }, [track]);

  const trackShare = useCallback((platform: string, url: string) => {
    track('share', { platform, url });
  }, [track]);

  const trackDownload = useCallback((file: string, type: string) => {
    track('download', { file, type });
  }, [track]);

  return {
    track,
    trackClick,
    trackFormSubmit,
    trackError,
    trackSearch,
    trackShare,
    trackDownload,
  };
}
```

### Root Layout Integration

```tsx
// apps/web/src/app/layout.tsx
import { AnalyticsProvider } from '@/providers/AnalyticsProvider';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <AnalyticsProvider>
          {/* Existing providers */}
          {children}
        </AnalyticsProvider>
      </body>
    </html>
  );
}
```

### Content Security Policy Configuration

```tsx
// apps/web/src/middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const response = NextResponse.next();

  // Get analytics domain from environment
  const analyticsDomain = process.env.NEXT_PUBLIC_UMAMI_DOMAIN || 'localhost:3001';

  // Configure CSP to allow Umami
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' ${analyticsDomain};
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: blob: ${analyticsDomain};
    font-src 'self';
    connect-src 'self' ${analyticsDomain};
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  `.replace(/\n/g, '').replace(/\s+/g, ' ').trim();

  response.headers.set('Content-Security-Policy', cspHeader);

  // Additional security headers
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=()');

  return response;
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};
```

### Environment Variables

```bash
# apps/web/.env.local
# Umami Analytics
NEXT_PUBLIC_ANALYTICS_ENABLED=true
NEXT_PUBLIC_UMAMI_WEBSITE_ID=your-website-id
NEXT_PUBLIC_UMAMI_SCRIPT_URL=http://localhost:3001/script.js
NEXT_PUBLIC_UMAMI_DOMAIN=localhost:3001
NEXT_PUBLIC_ANALYTICS_DOMAINS=localhost,sbozh.me
NEXT_PUBLIC_FORCE_ANALYTICS=false # Set to true to enable in development
```

### Example Component Usage

```tsx
// Example: Blog post component with analytics
import { useAnalytics } from '@/hooks/useAnalytics';

export function BlogPost({ post }: { post: Post }) {
  const { track, trackShare } = useAnalytics();

  useEffect(() => {
    // Track article read time
    const startTime = Date.now();

    return () => {
      const timeSpent = Math.round((Date.now() - startTime) / 1000);
      track('article_read', {
        article: post.slug,
        time_spent: timeSpent,
      });
    };
  }, [post.slug, track]);

  const handleShare = (platform: string) => {
    trackShare(platform, window.location.href);
    // Share logic...
  };

  return (
    <article>
      {/* Post content */}
      <ShareButtons onShare={handleShare} />
    </article>
  );
}
```

### Umami Dashboard Setup

```bash
# First-time setup after Docker containers are running

# 1. Access Umami at http://localhost:3001
# 2. Login with default credentials (admin/umami)
# 3. Change password immediately
# 4. Add website:
#    - Name: sbozh.me Development
#    - Domain: localhost
# 5. Copy the website ID to .env.local
# 6. Configure data retention (Settings > Data)
# 7. Set up team members if needed
```

### TypeScript Declarations

```typescript
// packages/web/src/types/analytics.d.ts
declare global {
  interface Window {
    umami?: {
      track: (event: string, data?: Record<string, any>) => void;
    };
  }
}

export {};
```

## Files to Create

| File | Purpose |
|------|---------|
| `packages/web/src/providers/AnalyticsProvider.tsx` | Main analytics provider |
| `packages/web/src/hooks/useAnalytics.ts` | Analytics tracking hooks |
| `packages/web/src/types/analytics.d.ts` | TypeScript declarations |
| `apps/web/src/middleware.ts` | CSP configuration |

## Files to Modify

| File | Changes |
|------|---------|
| `apps/web/src/app/layout.tsx` | Wrap with AnalyticsProvider |
| `apps/web/.env.example` | Add Umami configuration variables |
| `apps/web/.env.local` | Add actual Umami settings |
| `packages/web/package.json` | Update dependencies if needed |

## Acceptance Criteria

- [ ] Umami script loads successfully
- [ ] Page views tracked automatically on navigation
- [ ] Custom events can be tracked
- [ ] Analytics disabled in development by default
- [ ] CSP headers allow Umami connections
- [ ] No console errors related to analytics
- [ ] Dashboard shows incoming data
- [ ] TypeScript types properly defined
- [ ] Environment variables documented
- [ ] Performance impact minimal (<50ms)

## Testing

```tsx
// packages/web/src/hooks/__tests__/useAnalytics.test.ts
import { renderHook, act } from '@testing-library/react';
import { useAnalytics } from '../useAnalytics';

describe('useAnalytics', () => {
  beforeEach(() => {
    // Mock window.umami
    window.umami = {
      track: jest.fn(),
    };
  });

  afterEach(() => {
    delete window.umami;
  });

  it('tracks custom events', () => {
    const { result } = renderHook(() => useAnalytics());

    act(() => {
      result.current.track('test_event', { value: 123 });
    });

    expect(window.umami.track).toHaveBeenCalledWith('test_event', { value: 123 });
  });

  it('tracks clicks with category', () => {
    const { result } = renderHook(() => useAnalytics());

    act(() => {
      result.current.trackClick('button_1', 'header');
    });

    expect(window.umami.track).toHaveBeenCalledWith('click', {
      category: 'header',
      label: 'button_1',
    });
  });

  it('handles missing umami gracefully', () => {
    delete window.umami;
    const { result } = renderHook(() => useAnalytics());

    expect(() => {
      result.current.track('test_event');
    }).not.toThrow();
  });
});
```

## Verification

```bash
# 1. Start analytics services
cd deploy/analytics
docker-compose up -d

# 2. Start Next.js development server
pnpm dev

# 3. Check browser console for "Analytics: Umami loaded"

# 4. Navigate between pages and check Umami dashboard
# http://localhost:3001

# 5. Test custom events in browser console
window.umami.track('test_event', { test: true });

# 6. Verify CSP headers
curl -I http://localhost:3000 | grep -i content-security-policy
```

## Notes

- Umami respects Do Not Track (DNT) browser settings by default
- No cookies are used - Umami is GDPR compliant
- Consider implementing custom events gradually
- Monitor dashboard for unusual patterns
- Data retention policy should align with privacy policy
- Production URL will be configured in 0.10.0