# 0.9.0 - Analytics Infrastructure Setup

## Goal
Set up the foundational Docker infrastructure for Umami analytics and GlitchTip error tracking services with local development environment configuration.

## Deliverables
- [ ] Create deploy/analytics directory structure
- [ ] Configure Docker Compose with all required services
- [ ] Set up PostgreSQL database (shared or dedicated)
- [ ] Deploy Umami analytics service
- [ ] Deploy GlitchTip error tracking service
- [ ] Configure local domain routing
- [ ] Create environment variable templates

## Implementation

### Directory Structure
```
deploy/
├── analytics/
│   ├── docker-compose.yml
│   ├── .env.example
│   ├── .gitignore
│   └── README.md
└── production/
    └── README.md
```

### Docker Compose Configuration

```yaml
# deploy/analytics/docker-compose.yml
version: '3.8'

services:
  # PostgreSQL Database (shared for Umami and GlitchTip)
  postgres:
    image: postgres:15-alpine
    container_name: analytics-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - analytics-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Umami Analytics
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: umami
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${UMAMI_DATABASE}
      DATABASE_TYPE: postgresql
      APP_SECRET: ${UMAMI_APP_SECRET}
      HOSTNAME: ${UMAMI_HOSTNAME}
      PORT: 3000
    ports:
      - "3001:3000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - analytics-network
    restart: unless-stopped

  # Redis for GlitchTip
  redis:
    image: redis:7-alpine
    container_name: analytics-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - analytics-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # GlitchTip Error Tracking
  glitchtip-web:
    image: glitchtip/glitchtip:latest
    container_name: glitchtip-web
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${GLITCHTIP_DATABASE}
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
      EMAIL_URL: ${GLITCHTIP_EMAIL_URL}
      GLITCHTIP_DOMAIN: ${GLITCHTIP_DOMAIN}
      DEFAULT_FROM_EMAIL: ${GLITCHTIP_FROM_EMAIL}
      CELERY_BROKER_URL: redis://redis:6379/0
      CACHE_URL: redis://redis:6379/1
    ports:
      - "3002:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - analytics-network
    restart: unless-stopped

  # GlitchTip Worker
  glitchtip-worker:
    image: glitchtip/glitchtip:latest
    container_name: glitchtip-worker
    command: ./bin/run-celery-with-beat.sh
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${GLITCHTIP_DATABASE}
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
      CELERY_BROKER_URL: redis://redis:6379/0
      CACHE_URL: redis://redis:6379/1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - analytics-network
    restart: unless-stopped

  # GlitchTip Database Migrations
  glitchtip-migrate:
    image: glitchtip/glitchtip:latest
    container_name: glitchtip-migrate
    command: ./manage.py migrate
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${GLITCHTIP_DATABASE}
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - analytics-network
    restart: "no"

networks:
  analytics-network:
    driver: bridge
    name: analytics-network

  # Optional: Connect to existing Directus network if sharing DB
  # directus-network:
  #   external: true

volumes:
  postgres_data:
  redis_data:
```

### Database Initialization Script

```sql
-- deploy/analytics/init-db.sql
-- Create separate databases for Umami and GlitchTip
CREATE DATABASE umami_db;
CREATE DATABASE glitchtip_db;

-- Grant privileges (handled by environment variables)
```

### Environment Variables

```bash
# deploy/analytics/.env.example

# PostgreSQL Configuration
POSTGRES_USER=analytics_admin
POSTGRES_PASSWORD=change_this_strong_password
POSTGRES_DB=postgres

# Database Names
UMAMI_DATABASE=umami_db
GLITCHTIP_DATABASE=glitchtip_db

# Umami Configuration
UMAMI_APP_SECRET=change_this_random_32_char_string
UMAMI_HOSTNAME=analytics.local
# Default login: admin/umami

# GlitchTip Configuration
GLITCHTIP_SECRET_KEY=change_this_50_char_random_string
GLITCHTIP_DOMAIN=http://errors.local:3002
GLITCHTIP_FROM_EMAIL=errors@sbozh.me
GLITCHTIP_EMAIL_URL=smtp://localhost:25
# Optional: Email configuration for alerts
# GLITCHTIP_EMAIL_URL=smtp://user:pass@smtp.gmail.com:587/?_default_from_email=errors@sbozh.me&_use_tls=True

# Resource Limits (optional)
POSTGRES_MEMORY=512M
UMAMI_MEMORY=512M
GLITCHTIP_MEMORY=512M
REDIS_MEMORY=256M
```

### Local Domain Configuration

```bash
# Add to /etc/hosts for local development
127.0.0.1 analytics.local
127.0.0.1 errors.local
```

### Makefile Commands

```makefile
# deploy/analytics/Makefile
.PHONY: up down logs restart status setup

# Start all analytics services
up:
	docker-compose up -d

# Stop all analytics services
down:
	docker-compose down

# View logs
logs:
	docker-compose logs -f

# Restart services
restart:
	docker-compose restart

# Check service status
status:
	docker-compose ps

# Initial setup
setup:
	cp .env.example .env
	@echo "Please edit .env file with your configuration"
	@echo "Then run: make up"

# Clean everything (including volumes)
clean:
	docker-compose down -v
	rm -rf data/
```

## Files to Create

| File | Purpose |
|------|---------|
| `deploy/analytics/docker-compose.yml` | Main Docker Compose configuration |
| `deploy/analytics/.env.example` | Environment variable template |
| `deploy/analytics/.gitignore` | Ignore sensitive files |
| `deploy/analytics/README.md` | Setup and usage documentation |
| `deploy/analytics/Makefile` | Convenience commands |
| `deploy/analytics/init-db.sql` | Database initialization |
| `deploy/production/README.md` | Placeholder for 0.10.0 |

## Files to Modify

| File | Changes |
|------|---------|
| `ROADMAP.md` | Update 0.9.0 section with implementation details |
| `.gitignore` (root) | Add deploy/.env patterns |

## Acceptance Criteria

- [ ] Docker Compose starts all services successfully
- [ ] Umami accessible at http://localhost:3001
- [ ] GlitchTip accessible at http://localhost:3002
- [ ] PostgreSQL database properly initialized
- [ ] Redis cache functioning
- [ ] All services restart on failure
- [ ] Memory usage stays under 2GB total
- [ ] Environment variables properly configured
- [ ] Documentation complete for setup process
- [ ] No conflicts with existing Directus services

## Testing

```bash
# Test service startup
cd deploy/analytics
make setup
make up
make status

# Verify Umami
curl -I http://localhost:3001
# Expected: HTTP 200 response

# Verify GlitchTip
curl -I http://localhost:3002
# Expected: HTTP 200 response

# Check resource usage
docker stats --no-stream

# View logs for errors
make logs
```

## Notes

- Default Umami credentials: admin/umami (change immediately)
- GlitchTip will create admin user on first login
- Consider using Docker secrets for production (0.10.0)
- Network can be shared with Directus if needed
- Backup strategy will be addressed in 0.10.0