name: sbozh-me-production

services:
  database:
    image: postgis/postgis:13-master
    platform: linux/amd64
    restart: unless-stopped
    volumes:
      - /mnt/sbozh-me-data/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_DATABASE}
      # Production tuning
      POSTGRES_SHARED_BUFFERS: "1GB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "3GB"
      POSTGRES_MAINTENANCE_WORK_MEM: "256MB"
      POSTGRES_WORK_MEM: "16MB"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER}", "-d", "${DB_DATABASE}", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cache:
    image: redis:6-alpine
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  directus:
    build:
      context: ./directus
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:8055:8055"  # Only accessible via localhost (Nginx proxy)
    volumes:
      - /mnt/sbozh-me-data/directus/uploads:/directus/uploads
      # Extensions are built into the Docker image, not mounted from host
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    environment:
      # Core
      SECRET: ${DIRECTUS_SECRET}
      KEY: ${DIRECTUS_KEY}

      # Database
      DB_CLIENT: "pg"
      DB_HOST: "database"
      DB_PORT: "5432"
      DB_DATABASE: ${DB_DATABASE}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Cache
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_AUTO_PURGE: ${CACHE_AUTO_PURGE:-true}
      CACHE_STORE: "redis"
      CACHE_NAMESPACE: "directus-cache"
      REDIS: "redis://cache:6379"
      CACHE_TTL: "0"
      ASSETS_CACHE_TTL: "0"

      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      # Features
      WEBSOCKETS_ENABLED: ${WEBSOCKETS_ENABLED:-true}

      # URLs
      PUBLIC_URL: ${PUBLIC_URL}

      # CORS
      CORS_ENABLED: ${CORS_ENABLED:-true}
      CORS_ORIGIN: ${CORS_ORIGIN:-true}

      # Security
      REFRESH_TOKEN_COOKIE_SECURE: ${REFRESH_TOKEN_COOKIE_SECURE:-true}
      REFRESH_TOKEN_COOKIE_SAME_SITE: ${REFRESH_TOKEN_COOKIE_SAME_SITE:-lax}
      REFRESH_TOKEN_COOKIE_DOMAIN: ${REFRESH_TOKEN_COOKIE_DOMAIN}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-true}
      SESSION_COOKIE_SAME_SITE: ${SESSION_COOKIE_SAME_SITE:-lax}
      SESSION_COOKIE_DOMAIN: ${SESSION_COOKIE_DOMAIN}

      # Extensions
      EXTENSIONS_PATH: ${EXTENSIONS_PATH:-./extensions}
      EXTENSIONS_AUTO_RELOAD: ${EXTENSIONS_AUTO_RELOAD:-false}

      # CSP
      CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC: ${CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC:-'self'}

      # Email
      EMAIL_TRANSPORT: ${EMAIL_TRANSPORT:-smtp}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_SMTP_USER: ${EMAIL_SMTP_USER}
      EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD}
      EMAIL_SMTP_SECURE: ${EMAIL_SMTP_SECURE:-true}

      # Rate Limiting (production)
      RATE_LIMITER_ENABLED: "true"
      RATE_LIMITER_POINTS: "50"
      RATE_LIMITER_DURATION: "1"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_STYLE: "pretty"

    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://directus:8055/server/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  sbozh-me-network:
    driver: bridge
