name: sbozh-me-production

services:
  database:
    image: postgis/postgis:13-master
    platform: linux/amd64
    restart: unless-stopped
    volumes:
      - /mnt/sbozh-me-data/postgres:/var/lib/postgresql/data
      - ./init-umami-db.sh:/docker-entrypoint-initdb.d/init-umami-db.sh:ro
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_DATABASE}
      # Umami database credentials (for init script)
      UMAMI_DB_USER: ${UMAMI_DB_USER:-umami}
      UMAMI_DB_PASSWORD: ${UMAMI_DB_PASSWORD}
      UMAMI_DB_NAME: ${UMAMI_DB_NAME:-umami}
      # Production tuning
      POSTGRES_SHARED_BUFFERS: "1GB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "3GB"
      POSTGRES_MAINTENANCE_WORK_MEM: "256MB"
      POSTGRES_WORK_MEM: "16MB"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER}", "-d", "${DB_DATABASE}", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cache:
    image: redis:6-alpine
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  directus:
    image: directus/directus:11
    restart: unless-stopped
    ports:
      - "127.0.0.1:8055:8055"  # Only accessible via localhost (Nginx proxy)
    volumes:
      - /mnt/sbozh-me-data/directus/uploads:/directus/uploads
      # Extensions are built into the Docker image, not mounted from host
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    environment:
      # Core
      SECRET: ${DIRECTUS_SECRET}
      KEY: ${DIRECTUS_KEY}

      # Database
      DB_CLIENT: "pg"
      DB_HOST: "database"
      DB_PORT: "5432"
      DB_DATABASE: ${DB_DATABASE}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Cache
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_AUTO_PURGE: ${CACHE_AUTO_PURGE:-true}
      CACHE_STORE: "redis"
      CACHE_NAMESPACE: "directus-cache"
      REDIS: "redis://cache:6379"
      CACHE_TTL: "0"
      ASSETS_CACHE_TTL: "0"

      # Admin
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      # Features
      WEBSOCKETS_ENABLED: ${WEBSOCKETS_ENABLED:-true}

      # URLs
      PUBLIC_URL: ${PUBLIC_URL}

      # CORS
      CORS_ENABLED: ${CORS_ENABLED:-true}
      CORS_ORIGIN: ${CORS_ORIGIN:-true}

      # Security
      REFRESH_TOKEN_COOKIE_SECURE: ${REFRESH_TOKEN_COOKIE_SECURE:-true}
      REFRESH_TOKEN_COOKIE_SAME_SITE: ${REFRESH_TOKEN_COOKIE_SAME_SITE:-lax}
      REFRESH_TOKEN_COOKIE_DOMAIN: ${REFRESH_TOKEN_COOKIE_DOMAIN}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-true}
      SESSION_COOKIE_SAME_SITE: ${SESSION_COOKIE_SAME_SITE:-lax}
      SESSION_COOKIE_DOMAIN: ${SESSION_COOKIE_DOMAIN}

      # Extensions
      EXTENSIONS_PATH: ${EXTENSIONS_PATH:-./extensions}
      EXTENSIONS_AUTO_RELOAD: ${EXTENSIONS_AUTO_RELOAD:-false}

      # CSP
      CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC: ${CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC:-'self'}

      # Email
      EMAIL_TRANSPORT: ${EMAIL_TRANSPORT:-smtp}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_SMTP_USER: ${EMAIL_SMTP_USER}
      EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD}
      EMAIL_SMTP_SECURE: ${EMAIL_SMTP_SECURE:-true}

      # Rate Limiting (production)
      RATE_LIMITER_ENABLED: "true"
      RATE_LIMITER_POINTS: "50"
      RATE_LIMITER_DURATION: "1"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_STYLE: "pretty"

    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://directus:8055/server/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    image: ghcr.io/sbozh-me/website:${WEB_IMAGE_TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"  # Only accessible via localhost (Nginx proxy)
    depends_on:
      directus:
        condition: service_healthy
    environment:
      NODE_ENV: production
      # Runtime config (served via /api/config endpoint)
      DIRECTUS_URL: ${DIRECTUS_URL:-https://directus.sbozh.me}
      UMAMI_WEBSITE_ID: ${UMAMI_WEBSITE_ID}
      UMAMI_SCRIPT_URL: ${UMAMI_SCRIPT_URL:-https://analytics.sbozh.me/script.js}
      ANALYTICS_ENABLED: ${ANALYTICS_ENABLED:-true}
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3000"  # Nginx proxy in 0.11.4
    environment:
      DATABASE_URL: postgresql://${UMAMI_DB_USER:-umami}:${UMAMI_DB_PASSWORD}@database:5432/${UMAMI_DB_NAME:-umami}
      DATABASE_TYPE: postgresql
      APP_SECRET: ${UMAMI_APP_SECRET}
      DISABLE_TELEMETRY: 1
      DISABLE_UPDATES: 1
    depends_on:
      database:
        condition: service_healthy
    networks:
      - sbozh-me-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/heartbeat"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s

  # One-time init container to apply init things
  init:
    image: docker:cli
    volumes:
      - ./snapshots:/snapshots:ro
      - ./docker-init.sh:/docker-init.sh:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      directus:
        condition: service_healthy
    networks:
      - sbozh-me-network
    entrypoint: ["/bin/sh", "/docker-init.sh"]
    restart: "no"

networks:
  sbozh-me-network:
    driver: bridge
