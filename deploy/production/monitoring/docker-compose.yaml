name: sbozh-monitoring

x-environment: &default-environment
  DATABASE_URL: postgres://glitchtip:${POSTGRES_PASSWORD}@monitoring-database:5432/glitchtip
  SECRET_KEY: ${SECRET_KEY}
  PORT: 8000
  REDIS_URL: redis://monitoring-cache:6379/0
  GLITCHTIP_DOMAIN: ${GLITCHTIP_DOMAIN:-https://monitoring.sbozh.me}
  DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-errors@sbozh.me}
  EMAIL_URL: ${EMAIL_URL:-consolemail://}
  ENABLE_OPEN_USER_REGISTRATION: ${ENABLE_OPEN_USER_REGISTRATION:-False}
  CELERY_WORKER_AUTOSCALE: "1,3"
  CELERY_WORKER_CONCURRENCY: 2

services:
  # PostgreSQL Database for GlitchTip
  database:
    image: postgres:16-alpine
    container_name: monitoring-database
    hostname: monitoring-database
    environment:
      POSTGRES_DB: glitchtip
      POSTGRES_USER: glitchtip
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - /mnt/monitoring-data/postgres:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U glitchtip -d glitchtip"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      monitoring-network:
        aliases:
          - database
          - monitoring-database
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching and task queue
  cache:
    image: redis:7-alpine
    container_name: monitoring-cache
    hostname: monitoring-cache
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_interval: 5s
      start_period: 30s
    networks:
      monitoring-network:
        aliases:
          - cache
          - monitoring-cache
          - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # GlitchTip Web Service
  web:
    image: glitchtip/glitchtip:latest
    container_name: monitoring-web
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:8000:8000"  # Only accessible via localhost (Nginx proxy)
    environment: *default-environment
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/_health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - monitoring-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # GlitchTip Worker Service (Celery)
  worker:
    image: glitchtip/glitchtip:latest
    container_name: monitoring-worker
    command: celery -A glitchtip worker -B -l INFO
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment: *default-environment
    restart: unless-stopped
    networks:
      - monitoring-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Database Migration Service (runs once on startup)
  migrate:
    image: glitchtip/glitchtip:latest
    container_name: monitoring-migrate
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    command: "./manage.py migrate"
    environment: *default-environment
    networks:
      - monitoring-network

networks:
  monitoring-network:
    driver: bridge
