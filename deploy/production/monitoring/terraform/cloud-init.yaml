#cloud-config

# GlitchTip Monitoring Server Cloud-Init Configuration
# Automatically installs Docker, Docker Compose, and prepares the server
# Security: Creates non-root 'oktavian' user, hardens SSH, disables root SSH login

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - vim
  - htop
  - ufw
  - certbot
  - python3-certbot-nginx
  - python3-certbot-dns-cloudflare
  - nginx
  - sudo

# Create oktavian user with sudo access
users:
  - name: oktavian
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    create_home: true
    home: /home/oktavian
    ssh_authorized_keys:
      - ${ssh_public_key}

# Set root password (for emergency console access only)
chpasswd:
  list: |
    root:${root_password}
  expire: false

write_files:
  - path: /etc/sysctl.d/99-monitoring.conf
    content: |
      # Optimize for Docker and PostgreSQL
      vm.max_map_count=262144
      fs.file-max=65536
      net.core.somaxconn=1024
      net.ipv4.tcp_max_syn_backlog=2048

  - path: /home/oktavian/health-check.sh
    permissions: '0755'
    owner: oktavian:oktavian
    content: |
      #!/bin/bash
      echo "=== Monitoring Server Health Check ==="
      echo "Docker: $(docker --version)"
      echo "Docker Compose: $(docker compose version)"
      echo "Nginx: $(nginx -v 2>&1)"
      echo "Disk Usage: $(df -h / | tail -1)"
      echo "Memory: $(free -h | grep Mem)"
      echo "======================================"

  - path: /opt/monitoring/scripts/create-backup.sh
    permissions: '0755'
    owner: oktavian:oktavian
    content: |
      #!/bin/bash
      # Create backup of GlitchTip data
      # Usage: ./create-backup.sh

      set -e

      BACKUP_DIR="/mnt/monitoring-data/backups"
      APP_DIR="/opt/monitoring"
      DATE=$(date +%Y%m%d-%H%M%S)
      BACKUP_NAME="glitchtip-backup-$DATE"

      echo "=== GlitchTip Backup ==="
      echo "Date: $(date)"
      mkdir -p "$BACKUP_DIR"

      # Dump PostgreSQL
      echo "Dumping PostgreSQL..."
      docker compose -f "$APP_DIR/docker-compose.yaml" exec -T database \
        pg_dumpall -U glitchtip > "$BACKUP_DIR/$BACKUP_NAME-db.sql"

      # Compress database dump
      echo "Compressing backup..."
      gzip "$BACKUP_DIR/$BACKUP_NAME-db.sql"

      # Retention: keep last 7 backups
      ls -t "$BACKUP_DIR"/*-db.sql.gz 2>/dev/null | tail -n +8 | xargs -r rm

      echo "Backup complete: $BACKUP_DIR/$BACKUP_NAME-db.sql.gz"

  - path: /etc/ssh/sshd_config.d/99-monitoring-hardening.conf
    content: |
      # Monitoring Server SSH Hardening
      # Disable root login
      PermitRootLogin no

      # Disable password authentication (SSH keys only)
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      PubkeyAuthentication yes

      # Additional security
      X11Forwarding no
      MaxAuthTries 3
      MaxSessions 5

      # Only allow oktavian user
      AllowUsers oktavian

runcmd:
  # Apply sysctl changes
  - sysctl -p /etc/sysctl.d/99-monitoring.conf

  # Ensure oktavian home directory has proper permissions
  - mkdir -p /home/oktavian
  - chown -R oktavian:oktavian /home/oktavian
  - chmod 755 /home/oktavian

  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Start and enable Docker
  - systemctl start docker
  - systemctl enable docker

  # Add oktavian user to docker group (redundant but explicit)
  - usermod -aG docker oktavian

  # Configure Docker logging
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
    EOF
  - systemctl restart docker

  # Create application directory structure
  - mkdir -p /opt/monitoring/scripts
  - mkdir -p /mnt/monitoring-data/postgres
  - mkdir -p /mnt/monitoring-data/backups

  # Set ownership to oktavian user
  - chown -R oktavian:oktavian /opt/monitoring
  - chown -R oktavian:oktavian /mnt/monitoring-data

  # Set permissions
  - chmod -R 755 /mnt/monitoring-data
  - chmod -R 777 /mnt/monitoring-data/postgres

  # Configure UFW (redundant with Hetzner firewall, but good practice)
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp

  # Stop nginx initially (we'll configure it during deployment)
  - systemctl stop nginx
  - systemctl disable nginx

  # Restart SSH to apply hardening
  - systemctl restart sshd

  # Set up automatic security updates
  - apt-get install -y unattended-upgrades
  - dpkg-reconfigure -plow unattended-upgrades

  # Clean up
  - apt-get autoremove -y
  - apt-get clean

  # Write completion marker
  - echo "Cloud-init completed at $(date)" > /home/oktavian/cloud-init-completed.txt
  - chown oktavian:oktavian /home/oktavian/cloud-init-completed.txt
  - su - oktavian -c "/home/oktavian/health-check.sh > /home/oktavian/initial-health-check.txt"

final_message: |
  =============================================
     GlitchTip Monitoring Server Ready
  =============================================

  Security Configuration:
  - Non-root user 'oktavian' created
  - Root SSH login disabled
  - Password authentication disabled
  - SSH key authentication only

  System Configuration:
  - Docker installed
  - Nginx installed
  - SSL Certbot ready (Cloudflare DNS-01)
  - Data volume: /mnt/monitoring-data
  - Automatic security updates enabled

  Connect: ssh oktavian@<server-ip>
  Health check: /home/oktavian/health-check.sh

  Cloud-init setup completed successfully!
